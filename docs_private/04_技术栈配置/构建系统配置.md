# æ„å»ºç³»ç»Ÿé…ç½®

- **æ ‡é¢˜**: AIåä½œå¼€å‘æ„å»ºç³»ç»Ÿé…ç½®æŒ‡å—
- **å½“å‰ç‰ˆæœ¬**: v1.0
- **æœ€åæ›´æ–°**: 2025-09-10
- **è´Ÿè´£äºº**: Kelin

---

## æ„å»ºç³»ç»Ÿæ¶æ„

### ğŸ—ï¸ CMake é¡¹ç›®ç»“æ„

#### æ ¹ç›®å½• CMakeLists.txt
```cmake
# CMakeLists.txt - æ ¹ç›®å½•é…ç½®
cmake_minimum_required(VERSION 3.20)

# é¡¹ç›®å®šä¹‰
project(radar_mvp_system
    VERSION 1.0.0
    DESCRIPTION "Radar MVP System with GPU Acceleration"
    LANGUAGES CXX CUDA
)

# å…¨å±€é…ç½®
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

set(CMAKE_CUDA_STANDARD 17)
set(CMAKE_CUDA_STANDARD_REQUIRED ON)

# æ„å»ºç±»å‹è®¾ç½®
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release CACHE STRING "Build type" FORCE)
endif()

# è¾“å‡ºç›®å½•é…ç½®
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# åŒ…å«è‡ªå®šä¹‰ CMake æ¨¡å—
list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake")

# å¯¼å…¥é…ç½®æ–‡ä»¶
include(CompilerSettings)
include(PackageConfig)

# å­ç›®å½•
add_subdirectory(src)
add_subdirectory(tests)

# å®‰è£…é…ç½®
include(GNUInstallDirs)
install(TARGETS radar_core radar_gpu_lib
    EXPORT RadarTargets
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
)
```

#### ç¼–è¯‘å™¨è®¾ç½® (cmake/CompilerSettings.cmake)
```cmake
# cmake/CompilerSettings.cmake
# ç¼–è¯‘å™¨ç‰¹å®šé…ç½®

# é€šç”¨ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra")

# GCC ç‰¹å®šè®¾ç½®
if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
    # ç‰ˆæœ¬æ£€æŸ¥
    if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS "9.0")
        message(FATAL_ERROR "GCC version 9.0 or higher required")
    endif()

    # ä¼˜åŒ–é€‰é¡¹
    set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG -march=native -mtune=native")
    set(CMAKE_CXX_FLAGS_DEBUG "-O0 -g3 -DDEBUG -fno-omit-frame-pointer")
    set(CMAKE_CXX_FLAGS_RELWITHDEBINFO "-O2 -g -DNDEBUG")
    set(CMAKE_CXX_FLAGS_MINSIZEREL "-Os -DNDEBUG")

    # è­¦å‘Šé€‰é¡¹
    add_compile_options(
        -Wno-unused-parameter
        -Wno-missing-field-initializers
        -Wno-sign-compare
        -Wconversion
        -Wshadow
        -Wnon-virtual-dtor
        -Wold-style-cast
        -Wcast-align
        -Wunused
        -Woverloaded-virtual
        -Wpedantic
        -Wsign-conversion
        -Wmisleading-indentation
        -Wduplicated-cond
        -Wduplicated-branches
        -Wlogical-op
        -Wnull-dereference
        -Wuseless-cast
        -Wdouble-promotion
        -Wformat=2
    )

    # é“¾æ¥æ—¶ä¼˜åŒ–
    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        set(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)
    endif()

    # è°ƒè¯•ä¿¡æ¯å¢å¼º
    if(CMAKE_BUILD_TYPE STREQUAL "Debug")
        add_compile_options(-ggdb3)
    endif()

# Clang ç‰¹å®šè®¾ç½®
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
    # ç‰ˆæœ¬æ£€æŸ¥
    if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS "12.0")
        message(FATAL_ERROR "Clang version 12.0 or higher required")
    endif()

    # ä¼˜åŒ–é€‰é¡¹
    set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG -march=native -mtune=native")
    set(CMAKE_CXX_FLAGS_DEBUG "-O0 -g -DDEBUG")

    # è­¦å‘Šé€‰é¡¹
    add_compile_options(
        -Weverything
        -Wno-c++98-compat
        -Wno-c++98-compat-pedantic
        -Wno-padded
        -Wno-weak-vtables
        -Wno-exit-time-destructors
        -Wno-global-constructors
        -Wno-documentation-unknown-command
    )

# MSVC ç‰¹å®šè®¾ç½®
elseif(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
    # ç‰ˆæœ¬æ£€æŸ¥
    if(CMAKE_CXX_COMPILER_VERSION VERSION_LESS "19.28")
        message(FATAL_ERROR "MSVC version 19.28 (VS 2019 16.8) or higher required")
    endif()

    # ä¼˜åŒ–é€‰é¡¹
    set(CMAKE_CXX_FLAGS_RELEASE "/O2 /Ob2 /DNDEBUG")
    set(CMAKE_CXX_FLAGS_DEBUG "/Od /Zi /DEBUG /DDEBUG")

    # ç¼–è¯‘é€‰é¡¹
    add_compile_options(
        /W4                 # é«˜è­¦å‘Šçº§åˆ«
        /permissive-        # ä¸¥æ ¼æ ‡å‡†ç¬¦åˆæ€§
        /Zc:__cplusplus     # æ­£ç¡®çš„ __cplusplus å®
        /Zc:preprocessor    # ç¬¦åˆæ ‡å‡†çš„é¢„å¤„ç†å™¨
        /utf-8              # UTF-8 æºç å’Œæ‰§è¡Œå­—ç¬¦é›†
        /bigobj             # å¢åŠ ç›®æ ‡æ–‡ä»¶ä¸­çš„æ®µæ•°
    )

    # é“¾æ¥é€‰é¡¹
    add_link_options(
        /INCREMENTAL:NO     # ç¦ç”¨å¢é‡é“¾æ¥ (Release)
        $<$<CONFIG:Debug>:/INCREMENTAL>  # Debug å¯ç”¨å¢é‡é“¾æ¥
    )

    # ç¦ç”¨ç‰¹å®šè­¦å‘Š
    add_compile_definitions(
        _CRT_SECURE_NO_WARNINGS
        _SCL_SECURE_NO_WARNINGS
        NOMINMAX
        WIN32_LEAN_AND_MEAN
    )
endif()

# CUDA ç¼–è¯‘å™¨è®¾ç½®
if(CMAKE_CUDA_COMPILER)
    # CUDA æ¶æ„
    set(CMAKE_CUDA_ARCHITECTURES "60;61;70;75;80;86;89")

    # CUDA ç¼–è¯‘é€‰é¡¹
    set(CMAKE_CUDA_FLAGS "${CMAKE_CUDA_FLAGS} --extended-lambda --expt-relaxed-constexpr")
    set(CMAKE_CUDA_FLAGS_RELEASE "-O3 -DNDEBUG --use_fast_math")
    set(CMAKE_CUDA_FLAGS_DEBUG "-O0 -g -G -DDEBUG")

    # CUDA åˆ†ç¦»ç¼–è¯‘
    set(CMAKE_CUDA_SEPARABLE_COMPILATION ON)

    # PTX ç”Ÿæˆ
    set(CMAKE_CUDA_PTX_COMPILATION ON)
endif()

# åœ°å€å‡€åŒ–å™¨ (Debug æ„å»º)
option(ENABLE_ASAN "Enable AddressSanitizer" OFF)
if(ENABLE_ASAN AND CMAKE_BUILD_TYPE STREQUAL "Debug")
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU" OR CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
        add_compile_options(-fsanitize=address -fsanitize=undefined)
        add_link_options(-fsanitize=address -fsanitize=undefined)
    endif()
endif()

# æ€§èƒ½åˆ†æå™¨æ”¯æŒ
option(ENABLE_PROFILING "Enable profiling support" OFF)
if(ENABLE_PROFILING)
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        add_compile_options(-pg)
        add_link_options(-pg)
    endif()
endif()
```

#### åŒ…é…ç½® (cmake/PackageConfig.cmake)
```cmake
# cmake/PackageConfig.cmake
# ç¬¬ä¸‰æ–¹åŒ…é…ç½®å’ŒæŸ¥æ‰¾

# vcpkg é›†æˆ
if(DEFINED ENV{VCPKG_ROOT} AND NOT DEFINED CMAKE_TOOLCHAIN_FILE)
    set(CMAKE_TOOLCHAIN_FILE "$ENV{VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake"
        CACHE STRING "Vcpkg toolchain file")
endif()

# pkg-config æ”¯æŒ
find_package(PkgConfig QUIET)

# === å¿…éœ€ä¾èµ– ===

# Boost
set(Boost_USE_STATIC_LIBS ON)
set(Boost_USE_MULTITHREADED ON)
find_package(Boost 1.75.0 REQUIRED
    COMPONENTS system filesystem thread program_options
)

# CUDA
find_package(CUDAToolkit 12.0 REQUIRED)

# yaml-cpp
find_package(yaml-cpp 0.7.0 REQUIRED)

# spdlog
find_package(spdlog 1.9.0 REQUIRED)

# OpenGL
find_package(OpenGL REQUIRED)
if(NOT OpenGL_GL_PREFERENCE)
    set(OpenGL_GL_PREFERENCE GLVND)
endif()

# GLFW
find_package(glfw3 3.3 REQUIRED)

# GLEW
find_package(GLEW 2.2.0 REQUIRED)

# === å¯é€‰ä¾èµ– ===

# Eigen3 (çº¿æ€§ä»£æ•°)
find_package(Eigen3 3.4.0 QUIET)
if(Eigen3_FOUND)
    message(STATUS "Found Eigen3: ${Eigen3_VERSION}")
    set(HAVE_EIGEN3 TRUE)
else()
    message(STATUS "Eigen3 not found - some features will be disabled")
    set(HAVE_EIGEN3 FALSE)
endif()

# Intel MKL (æ•°å­¦å†…æ ¸åº“)
find_package(MKL QUIET)
if(MKL_FOUND)
    message(STATUS "Found Intel MKL: ${MKL_VERSION}")
    set(HAVE_MKL TRUE)
else()
    message(STATUS "Intel MKL not found - fallback to standard libraries")
    set(HAVE_MKL FALSE)
endif()

# ImGui (GUI)
find_package(imgui QUIET)
if(imgui_FOUND)
    message(STATUS "Found ImGui")
    set(HAVE_IMGUI TRUE)
else()
    message(STATUS "ImGui not found - GUI features will be disabled")
    set(HAVE_IMGUI FALSE)
endif()

# === æµ‹è¯•ä¾èµ– ===
option(BUILD_TESTS "Build tests" ON)
if(BUILD_TESTS)
    # Google Test
    find_package(GTest 1.12.0 QUIET)
    if(NOT GTest_FOUND)
        include(FetchContent)
        FetchContent_Declare(
            googletest
            URL https://github.com/google/googletest/archive/03597a01ee50f33f9142904e5b22ac5a8b0ad4e3.zip
        )
        FetchContent_MakeAvailable(googletest)
    endif()

    # Google Benchmark
    find_package(benchmark QUIET)
    if(NOT benchmark_FOUND)
        include(FetchContent)
        FetchContent_Declare(
            googlebenchmark
            URL https://github.com/google/benchmark/archive/v1.7.1.zip
        )
        set(BENCHMARK_ENABLE_TESTING OFF)
        FetchContent_MakeAvailable(googlebenchmark)
    endif()
endif()

# === ä¾èµ–æ£€æŸ¥å’ŒæŠ¥å‘Š ===
function(print_dependency_summary)
    message(STATUS "=== Dependency Summary ===")
    message(STATUS "Required dependencies:")
    message(STATUS "  Boost: ${Boost_VERSION}")
    message(STATUS "  CUDA: ${CUDAToolkit_VERSION}")
    message(STATUS "  yaml-cpp: ${yaml-cpp_VERSION}")
    message(STATUS "  spdlog: ${spdlog_VERSION}")
    message(STATUS "  OpenGL: ${OPENGL_VERSION}")

    message(STATUS "Optional dependencies:")
    message(STATUS "  Eigen3: ${HAVE_EIGEN3}")
    message(STATUS "  Intel MKL: ${HAVE_MKL}")
    message(STATUS "  ImGui: ${HAVE_IMGUI}")

    if(BUILD_TESTS)
        message(STATUS "Test dependencies:")
        message(STATUS "  GTest: ${GTest_FOUND}")
        message(STATUS "  Benchmark: ${benchmark_FOUND}")
    endif()
    message(STATUS "========================")
endfunction()

# ç”Ÿæˆé…ç½®å¤´æ–‡ä»¶
configure_file(
    "${CMAKE_SOURCE_DIR}/include/common/config.h.in"
    "${CMAKE_BINARY_DIR}/include/common/config.h"
    @ONLY
)

# è°ƒç”¨ä¾èµ–æ‘˜è¦
print_dependency_summary()
```

---

## æ„å»ºé…ç½®å’Œé€‰é¡¹

### âš™ï¸ æ„å»ºç±»å‹é…ç½®

#### æ„å»ºç±»å‹å®šä¹‰
```cmake
# è‡ªå®šä¹‰æ„å»ºç±»å‹
set(CMAKE_CONFIGURATION_TYPES "Debug;Release;RelWithDebInfo;MinSizeRel;Profile" CACHE STRING "" FORCE)

# Profile æ„å»ºç±»å‹
set(CMAKE_CXX_FLAGS_PROFILE "-O2 -g -DNDEBUG -DENABLE_PROFILING")
set(CMAKE_CUDA_FLAGS_PROFILE "-O2 -g -DNDEBUG")

# æ„å»ºé€‰é¡¹
option(BUILD_SHARED_LIBS "Build shared libraries" OFF)
option(BUILD_TESTS "Build tests" ON)
option(BUILD_BENCHMARKS "Build benchmarks" OFF)
option(BUILD_DOCUMENTATION "Build documentation" OFF)
option(BUILD_EXAMPLES "Build examples" ON)

# åŠŸèƒ½é€‰é¡¹
option(ENABLE_CUDA "Enable CUDA support" ON)
option(ENABLE_OPENGL "Enable OpenGL support" ON)
option(ENABLE_GUI "Enable GUI components" ON)
option(ENABLE_PROFILING "Enable profiling support" OFF)
option(ENABLE_LOGGING "Enable detailed logging" ON)

# æ€§èƒ½é€‰é¡¹
option(USE_FAST_MATH "Use fast math optimizations" ON)
option(ENABLE_LTO "Enable Link Time Optimization" ON)
option(ENABLE_NATIVE_ARCH "Enable native architecture optimization" ON)
```

#### æ¡ä»¶ç¼–è¯‘é…ç½®
```cmake
# ç”Ÿæˆé…ç½®å¤´æ–‡ä»¶æ¨¡æ¿
# include/common/config.h.in
#pragma once

// ç‰ˆæœ¬ä¿¡æ¯
#define RADAR_VERSION_MAJOR @PROJECT_VERSION_MAJOR@
#define RADAR_VERSION_MINOR @PROJECT_VERSION_MINOR@
#define RADAR_VERSION_PATCH @PROJECT_VERSION_PATCH@
#define RADAR_VERSION_STRING "@PROJECT_VERSION@"

// åŠŸèƒ½å¼€å…³
#cmakedefine HAVE_CUDA
#cmakedefine HAVE_OPENGL
#cmakedefine HAVE_EIGEN3
#cmakedefine HAVE_MKL
#cmakedefine HAVE_IMGUI

// æ„å»ºé…ç½®
#cmakedefine BUILD_SHARED_LIBS
#cmakedefine ENABLE_PROFILING
#cmakedefine ENABLE_LOGGING
#cmakedefine USE_FAST_MATH

// ç¼–è¯‘å™¨ä¿¡æ¯
#define COMPILER_ID "@CMAKE_CXX_COMPILER_ID@"
#define COMPILER_VERSION "@CMAKE_CXX_COMPILER_VERSION@"

// æ„å»ºä¿¡æ¯
#define BUILD_TYPE "@CMAKE_BUILD_TYPE@"
#define BUILD_TIMESTAMP "@BUILD_TIMESTAMP@"
```

### ğŸ¯ æ¨¡å—åŒ–æ„å»ºé…ç½®

#### æ ¸å¿ƒæ¨¡å— CMakeLists.txt
```cmake
# src/CMakeLists.txt
# ä¸»è¦æºç ç›®å½•

# æ·»åŠ å­ç›®å½•
add_subdirectory(common)
add_subdirectory(modules)
add_subdirectory(application)

# ä¸»å¯æ‰§è¡Œæ–‡ä»¶
add_executable(radar_system main.cpp)

# é“¾æ¥åº“
target_link_libraries(radar_system
    PRIVATE
        radar_app
        radar_common
        radar_modules
)

# åŒ…å«ç›®å½•
target_include_directories(radar_system
    PRIVATE
        ${CMAKE_SOURCE_DIR}/include
        ${CMAKE_BINARY_DIR}/include
)

# ç¼–è¯‘å®šä¹‰
target_compile_definitions(radar_system
    PRIVATE
        $<$<CONFIG:Debug>:DEBUG_BUILD>
        $<$<CONFIG:Release>:RELEASE_BUILD>
)

# é“¾æ¥é€‰é¡¹
if(WIN32)
    target_link_options(radar_system PRIVATE /SUBSYSTEM:CONSOLE)
endif()
```

#### æ¨¡å—æ„å»ºé…ç½®
```cmake
# src/modules/CMakeLists.txt
# æ¨¡å—åº“æ„å»º

# åˆ›å»ºæ¨¡å—åº“
add_library(radar_modules)

# æ·»åŠ å­æ¨¡å—
add_subdirectory(data_receiver)
add_subdirectory(protocol_parser)
add_subdirectory(gpu_processor)
add_subdirectory(display_control)
add_subdirectory(task_scheduler)

# æ¨¡å—æ¥å£åº“
add_library(radar_module_interfaces INTERFACE)
target_include_directories(radar_module_interfaces
    INTERFACE
        ${CMAKE_SOURCE_DIR}/include/interfaces
)

# GPU å¤„ç†æ¨¡å— (CUDA)
if(ENABLE_CUDA AND CMAKE_CUDA_COMPILER)
    add_subdirectory(gpu_processor)
    target_link_libraries(radar_modules
        PUBLIC
            radar_gpu_processor
            CUDA::cudart
            CUDA::cufft
            CUDA::cublas
    )
endif()

# é“¾æ¥æ‰€æœ‰æ¨¡å—
target_link_libraries(radar_modules
    PUBLIC
        radar_module_interfaces
        radar_data_receiver
        radar_protocol_parser
        radar_display_control
        radar_task_scheduler
    PRIVATE
        Boost::system
        Boost::filesystem
        Boost::thread
        yaml-cpp
        spdlog::spdlog
)

# å¯¼å‡ºç¬¦å· (Windows DLL)
if(WIN32 AND BUILD_SHARED_LIBS)
    target_compile_definitions(radar_modules
        PRIVATE RADAR_MODULES_EXPORTS
        INTERFACE RADAR_MODULES_IMPORTS
    )
endif()
```

#### CUDA æ¨¡å—æ„å»º
```cmake
# src/modules/gpu_processor/CMakeLists.txt
# GPU å¤„ç†æ¨¡å—

if(NOT ENABLE_CUDA OR NOT CMAKE_CUDA_COMPILER)
    message(STATUS "CUDA disabled or not found, skipping GPU processor")
    return()
endif()

# CUDA åº“
add_library(radar_gpu_processor)

# CUDA æºæ–‡ä»¶
target_sources(radar_gpu_processor
    PRIVATE
        gpu_processor.cpp
        cuda_kernels.cu
        fft_processor.cu
        signal_processor.cu
)

# CUDA ç‰¹å®šè®¾ç½®
set_target_properties(radar_gpu_processor PROPERTIES
    CUDA_STANDARD 17
    CUDA_STANDARD_REQUIRED ON
    CUDA_EXTENSIONS OFF
    CUDA_SEPARABLE_COMPILATION ON
    POSITION_INDEPENDENT_CODE ON
)

# CUDA ç¼–è¯‘é€‰é¡¹
target_compile_options(radar_gpu_processor
    PRIVATE
        $<$<COMPILE_LANGUAGE:CUDA>:
            --extended-lambda
            --expt-relaxed-constexpr
            --use_fast_math
            -Xcompiler=-fPIC
        >
)

# æ¶æ„ç‰¹å®šä¼˜åŒ–
set(CUDA_ARCH_FLAGS)
foreach(arch IN LISTS CMAKE_CUDA_ARCHITECTURES)
    if(arch MATCHES "^([0-9]+)$")
        list(APPEND CUDA_ARCH_FLAGS "-gencode=arch=compute_${arch},code=sm_${arch}")
    endif()
endforeach()
target_compile_options(radar_gpu_processor
    PRIVATE
        $<$<COMPILE_LANGUAGE:CUDA>:${CUDA_ARCH_FLAGS}>
)

# é“¾æ¥ CUDA åº“
target_link_libraries(radar_gpu_processor
    PUBLIC
        CUDA::cudart
        CUDA::cufft
        CUDA::cublas
        CUDA::curand
    PRIVATE
        radar_common
)

# åŒ…å«ç›®å½•
target_include_directories(radar_gpu_processor
    PUBLIC
        ${CMAKE_SOURCE_DIR}/include/modules/gpu_processor
    PRIVATE
        ${CMAKE_CUDA_TOOLKIT_INCLUDE_DIRECTORIES}
)
```

---

## æµ‹è¯•æ„å»ºé…ç½®

### ğŸ§ª æµ‹è¯•æ¡†æ¶é›†æˆ

#### æµ‹è¯•æ ¹ç›®å½•é…ç½®
```cmake
# tests/CMakeLists.txt
# æµ‹è¯•æ„å»ºé…ç½®

if(NOT BUILD_TESTS)
    return()
endif()

enable_testing()

# æµ‹è¯•è¾…åŠ©å‡½æ•°
function(add_radar_test test_name)
    set(options)
    set(oneValueArgs)
    set(multiValueArgs SOURCES LIBRARIES)
    cmake_parse_arguments(TEST "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    add_executable(${test_name} ${TEST_SOURCES})

    target_link_libraries(${test_name}
        PRIVATE
            ${TEST_LIBRARIES}
            GTest::gtest
            GTest::gtest_main
            GTest::gmock
    )

    target_include_directories(${test_name}
        PRIVATE
            ${CMAKE_SOURCE_DIR}/include
            ${CMAKE_SOURCE_DIR}/tests/mock
    )

    add_test(NAME ${test_name} COMMAND ${test_name})

    # æµ‹è¯•å±æ€§
    set_tests_properties(${test_name} PROPERTIES
        TIMEOUT 30
        LABELS "unit"
    )
endfunction()

# æ·»åŠ æµ‹è¯•å­ç›®å½•
add_subdirectory(unit_tests)
add_subdirectory(integration_tests)
if(BUILD_BENCHMARKS)
    add_subdirectory(performance_tests)
endif()

# æµ‹è¯•è¦†ç›–ç‡é…ç½®
option(ENABLE_COVERAGE "Enable code coverage" OFF)
if(ENABLE_COVERAGE AND CMAKE_BUILD_TYPE STREQUAL "Debug")
    if(CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        target_compile_options(radar_test_common INTERFACE
            --coverage -fno-inline -fno-inline-small-functions -fno-default-inline
        )
        target_link_options(radar_test_common INTERFACE --coverage)
    endif()
endif()
```

#### å•å…ƒæµ‹è¯•é…ç½®
```cmake
# tests/unit_tests/CMakeLists.txt
# å•å…ƒæµ‹è¯•

# æµ‹è¯•é€šç”¨åº“
add_library(radar_test_common INTERFACE)
target_include_directories(radar_test_common
    INTERFACE
        ${CMAKE_SOURCE_DIR}/tests/mock
        ${CMAKE_SOURCE_DIR}/include
)

# æ¨¡å—å•å…ƒæµ‹è¯•
add_subdirectory(common)
add_subdirectory(data_receiver)
add_subdirectory(protocol_parser)
add_subdirectory(gpu_processor)
add_subdirectory(display_control)
add_subdirectory(task_scheduler)

# æ•°æ®æ¥æ”¶å™¨æµ‹è¯•
add_radar_test(test_data_receiver
    SOURCES
        data_receiver/test_data_receiver.cpp
        data_receiver/test_packet_parser.cpp
    LIBRARIES
        radar_modules
        radar_test_common
)

# GPU å¤„ç†å™¨æµ‹è¯•
if(ENABLE_CUDA)
    add_radar_test(test_gpu_processor
        SOURCES
            gpu_processor/test_gpu_processor.cpp
            gpu_processor/test_cuda_kernels.cpp
        LIBRARIES
            radar_gpu_processor
            radar_test_common
            CUDA::cudart
    )

    # GPU æµ‹è¯•éœ€è¦ GPU ç¡¬ä»¶
    set_tests_properties(test_gpu_processor PROPERTIES
        LABELS "gpu;unit"
        RESOURCE_GROUPS "gpu:1"
    )
endif()
```

#### æ€§èƒ½æµ‹è¯•é…ç½®
```cmake
# tests/performance_tests/CMakeLists.txt
# æ€§èƒ½åŸºå‡†æµ‹è¯•

if(NOT BUILD_BENCHMARKS)
    return()
endif()

# åŸºå‡†æµ‹è¯•è¾…åŠ©å‡½æ•°
function(add_radar_benchmark benchmark_name)
    set(options)
    set(oneValueArgs)
    set(multiValueArgs SOURCES LIBRARIES)
    cmake_parse_arguments(BENCH "${options}" "${oneValueArgs}" "${multiValueArgs}" ${ARGN})

    add_executable(${benchmark_name} ${BENCH_SOURCES})

    target_link_libraries(${benchmark_name}
        PRIVATE
            ${BENCH_LIBRARIES}
            benchmark::benchmark
            benchmark::benchmark_main
    )

    target_include_directories(${benchmark_name}
        PRIVATE
            ${CMAKE_SOURCE_DIR}/include
    )

    # åŸºå‡†æµ‹è¯•ä¸ä½œä¸ºå¸¸è§„æµ‹è¯•è¿è¡Œ
    # add_test(NAME ${benchmark_name} COMMAND ${benchmark_name})
endfunction()

# GPU å¤„ç†æ€§èƒ½æµ‹è¯•
if(ENABLE_CUDA)
    add_radar_benchmark(benchmark_gpu_processor
        SOURCES
            gpu_fft_benchmark.cpp
            gpu_signal_processing_benchmark.cpp
        LIBRARIES
            radar_gpu_processor
    )
endif()

# æ•°æ®å¤„ç†æ€§èƒ½æµ‹è¯•
add_radar_benchmark(benchmark_data_processing
    SOURCES
        data_receiver_benchmark.cpp
        protocol_parser_benchmark.cpp
    LIBRARIES
        radar_modules
)
```

---

## åŒ…ç®¡ç†å’Œä¾èµ–

### ğŸ“¦ vcpkg é›†æˆé…ç½®

#### vcpkg.json é…ç½®
```json
{
  "name": "radar-mvp-system",
  "version": "1.0.0",
  "description": "Radar MVP System with GPU Acceleration",
  "dependencies": [
    {
      "name": "boost",
      "version>=": "1.75.0",
      "default-features": false,
      "features": ["system", "filesystem", "thread", "program-options"]
    },
    {
      "name": "yaml-cpp",
      "version>=": "0.7.0"
    },
    {
      "name": "spdlog",
      "version>=": "1.9.0",
      "features": ["std_format"]
    },
    {
      "name": "glfw3",
      "version>=": "3.3.0"
    },
    {
      "name": "glew",
      "version>=": "2.2.0"
    },
    {
      "name": "opengl",
      "platform": "!osx"
    },
    {
      "name": "eigen3",
      "version>=": "3.4.0"
    },
    {
      "name": "imgui",
      "version>=": "1.89.0",
      "features": ["opengl3-binding", "glfw-binding"]
    }
  ],
  "features": {
    "tests": {
      "description": "Build with testing support",
      "dependencies": [
        {
          "name": "gtest",
          "version>=": "1.12.0"
        },
        {
          "name": "benchmark",
          "version>=": "1.7.0"
        }
      ]
    },
    "mkl": {
      "description": "Intel MKL support",
      "dependencies": [
        {
          "name": "intel-mkl",
          "platform": "x64"
        }
      ]
    }
  },
  "builtin-baseline": "2023.08.09"
}
```

#### vcpkg è‡ªå®šä¹‰ç«¯å£
```cmake
# ports/cuda-toolkit/portfile.cmake
# è‡ªå®šä¹‰ CUDA å·¥å…·åŒ…ç«¯å£

set(VCPKG_POLICY_EMPTY_PACKAGE enabled)

if(NOT VCPKG_TARGET_IS_WINDOWS AND NOT VCPKG_TARGET_IS_LINUX)
    message(FATAL_ERROR "CUDA Toolkit is only supported on Windows and Linux")
endif()

# CUDA ç‰ˆæœ¬æ£€æµ‹
find_program(NVCC_EXECUTABLE nvcc
    HINTS
        $ENV{CUDA_PATH}/bin
        $ENV{CUDA_HOME}/bin
        /usr/local/cuda/bin
        /opt/cuda/bin
)

if(NOT NVCC_EXECUTABLE)
    message(FATAL_ERROR "CUDA Toolkit not found. Please install CUDA Toolkit 12.0 or later.")
endif()

# ç‰ˆæœ¬æ£€æŸ¥
execute_process(
    COMMAND ${NVCC_EXECUTABLE} --version
    OUTPUT_VARIABLE NVCC_VERSION_OUTPUT
    ERROR_QUIET
)

string(REGEX MATCH "release ([0-9]+\\.[0-9]+)" NVCC_VERSION_MATCH "${NVCC_VERSION_OUTPUT}")
set(CUDA_VERSION ${CMAKE_MATCH_1})

if(CUDA_VERSION VERSION_LESS "12.0")
    message(FATAL_ERROR "CUDA Toolkit version ${CUDA_VERSION} found, but version 12.0 or later required")
endif()

message(STATUS "Found CUDA Toolkit version: ${CUDA_VERSION}")

# åˆ›å»ºç›®æ ‡
file(WRITE ${CURRENT_PACKAGES_DIR}/share/cuda-toolkit/cuda-toolkit-config.cmake
"set(CUDA_TOOLKIT_FOUND TRUE)
set(CUDA_TOOLKIT_VERSION \"${CUDA_VERSION}\")
")
```

### ğŸ”§ Conan é›†æˆé…ç½®

#### conanfile.py
```python
from conan import ConanFile
from conan.tools.cmake import CMakeToolchain, CMakeDeps, cmake_layout
from conan.tools.files import copy


class RadarMvpConan(ConanFile):
    name = "radar-mvp-system"
    version = "1.0.0"

    # åŒ…ä¿¡æ¯
    description = "Radar MVP System with GPU Acceleration"
    topics = ("radar", "gpu", "signal-processing", "realtime")
    url = "https://github.com/your-org/radar-mvp-system"
    license = "MIT"

    # è®¾ç½®
    settings = "os", "compiler", "build_type", "arch"
    options = {
        "shared": [True, False],
        "fPIC": [True, False],
        "with_cuda": [True, False],
        "with_mkl": [True, False],
        "with_gui": [True, False],
    }
    default_options = {
        "shared": False,
        "fPIC": True,
        "with_cuda": True,
        "with_mkl": False,
        "with_gui": True,
    }

    # ä¾èµ–
    def requirements(self):
        # æ ¸å¿ƒä¾èµ–
        self.requires("boost/1.82.0")
        self.requires("yaml-cpp/0.7.0")
        self.requires("spdlog/1.12.0")

        # å›¾å½¢ä¾èµ–
        if self.options.with_gui:
            self.requires("glfw/3.3.8")
            self.requires("glew/2.2.0")
            self.requires("imgui/1.89.9")

        # æ•°å­¦åº“
        self.requires("eigen/3.4.0")
        if self.options.with_mkl:
            self.requires("intel-oneapi-mkl/2023.1.0")

    def build_requirements(self):
        self.test_requires("gtest/1.13.0")
        self.test_requires("benchmark/1.8.0")

    def configure(self):
        if self.settings.os == "Windows":
            self.options["boost"].shared = True

    def layout(self):
        cmake_layout(self)

    def generate(self):
        tc = CMakeToolchain(self)
        tc.variables["WITH_CUDA"] = self.options.with_cuda
        tc.variables["WITH_MKL"] = self.options.with_mkl
        tc.variables["WITH_GUI"] = self.options.with_gui
        tc.generate()

        deps = CMakeDeps(self)
        deps.generate()
```

---

## æ„å»ºè„šæœ¬å’Œè‡ªåŠ¨åŒ–

### ğŸ¤– è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

#### Windows æ„å»ºè„šæœ¬
```powershell
# scripts/build/build_windows.ps1
# Windows è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

param(
    [string]$BuildType = "Release",
    [switch]$Clean = $false,
    [switch]$Tests = $true,
    [switch]$UseVcpkg = $true,
    [switch]$EnableCuda = $true,
    [int]$Jobs = 0
)

# é”™è¯¯å¤„ç†
$ErrorActionPreference = "Stop"

# è·å–è„šæœ¬ç›®å½•
$ScriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
$RootDir = Split-Path -Parent (Split-Path -Parent $ScriptDir)

Write-Host "=== Radar MVP System - Windows Build Script ===" -ForegroundColor Green
Write-Host "Build Type: $BuildType" -ForegroundColor Yellow
Write-Host "Root Directory: $RootDir" -ForegroundColor Yellow

# æ£€æŸ¥å¿…éœ€å·¥å…·
function Test-Command($Command) {
    try {
        Get-Command $Command -ErrorAction Stop | Out-Null
        return $true
    }
    catch {
        return $false
    }
}

Write-Host "Checking required tools..." -ForegroundColor Blue

if (-not (Test-Command "cmake")) {
    throw "CMake not found. Please install CMake 3.20 or later."
}

if (-not (Test-Command "ninja")) {
    Write-Warning "Ninja not found. Falling back to Visual Studio generator."
    $Generator = "Visual Studio 17 2022"
} else {
    $Generator = "Ninja"
}

if ($EnableCuda -and -not (Test-Command "nvcc")) {
    Write-Warning "NVCC not found. CUDA support will be disabled."
    $EnableCuda = $false
}

# è®¾ç½®å¹¶è¡Œä½œä¸šæ•°
if ($Jobs -eq 0) {
    $Jobs = [Environment]::ProcessorCount
}

Write-Host "Using $Jobs parallel jobs" -ForegroundColor Blue

# æ„å»ºç›®å½•
$BuildDir = Join-Path $RootDir "build"
$InstallDir = Join-Path $RootDir "install"

# æ¸…ç†æ„å»º
if ($Clean -and (Test-Path $BuildDir)) {
    Write-Host "Cleaning build directory..." -ForegroundColor Blue
    Remove-Item -Recurse -Force $BuildDir
}

# åˆ›å»ºæ„å»ºç›®å½•
if (-not (Test-Path $BuildDir)) {
    New-Item -ItemType Directory -Path $BuildDir | Out-Null
}

# CMake é…ç½®å‚æ•°
$CmakeArgs = @(
    "-G", $Generator,
    "-DCMAKE_BUILD_TYPE=$BuildType",
    "-DCMAKE_INSTALL_PREFIX=$InstallDir",
    "-DBUILD_TESTS=$($Tests ? 'ON' : 'OFF')",
    "-DENABLE_CUDA=$($EnableCuda ? 'ON' : 'OFF')"
)

# vcpkg é›†æˆ
if ($UseVcpkg) {
    $VcpkgRoot = $env:VCPKG_ROOT
    if ($VcpkgRoot -and (Test-Path $VcpkgRoot)) {
        $VcpkgToolchain = Join-Path $VcpkgRoot "scripts/buildsystems/vcpkg.cmake"
        $CmakeArgs += "-DCMAKE_TOOLCHAIN_FILE=$VcpkgToolchain"
        Write-Host "Using vcpkg: $VcpkgRoot" -ForegroundColor Blue
    } else {
        Write-Warning "VCPKG_ROOT not set or invalid. Skipping vcpkg integration."
    }
}

# é…ç½®
Write-Host "Configuring..." -ForegroundColor Blue
Set-Location $BuildDir
& cmake $RootDir @CmakeArgs
if ($LASTEXITCODE -ne 0) {
    throw "CMake configuration failed"
}

# æ„å»º
Write-Host "Building..." -ForegroundColor Blue
& cmake --build . --config $BuildType --parallel $Jobs
if ($LASTEXITCODE -ne 0) {
    throw "Build failed"
}

# æµ‹è¯•
if ($Tests) {
    Write-Host "Running tests..." -ForegroundColor Blue
    & ctest --config $BuildType --parallel $Jobs --output-on-failure
    if ($LASTEXITCODE -ne 0) {
        Write-Warning "Some tests failed"
    }
}

# å®‰è£…
Write-Host "Installing..." -ForegroundColor Blue
& cmake --build . --config $BuildType --target install
if ($LASTEXITCODE -ne 0) {
    throw "Installation failed"
}

Write-Host "Build completed successfully!" -ForegroundColor Green
Write-Host "Install directory: $InstallDir" -ForegroundColor Yellow

# è¿”å›åŸç›®å½•
Set-Location $RootDir
```

#### Linux æ„å»ºè„šæœ¬
```bash
#!/bin/bash
# scripts/build/build_linux.sh
# Linux è‡ªåŠ¨åŒ–æ„å»ºè„šæœ¬

set -euo pipefail

# é»˜è®¤å‚æ•°
BUILD_TYPE="Release"
CLEAN=false
TESTS=true
USE_CONAN=false
ENABLE_CUDA=true
JOBS=$(nproc)

# å‚æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        --build-type)
            BUILD_TYPE="$2"
            shift 2
            ;;
        --clean)
            CLEAN=true
            shift
            ;;
        --no-tests)
            TESTS=false
            shift
            ;;
        --use-conan)
            USE_CONAN=true
            shift
            ;;
        --no-cuda)
            ENABLE_CUDA=false
            shift
            ;;
        --jobs)
            JOBS="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# è·å–è„šæœ¬ç›®å½•
SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
ROOT_DIR=$(dirname "$(dirname "$SCRIPT_DIR")")

echo "=== Radar MVP System - Linux Build Script ==="
echo "Build Type: $BUILD_TYPE"
echo "Root Directory: $ROOT_DIR"

# æ£€æŸ¥å¿…éœ€å·¥å…·
command -v cmake >/dev/null 2>&1 || { echo "CMake not found"; exit 1; }
command -v ninja >/dev/null 2>&1 || { echo "Ninja not found"; exit 1; }

if [[ "$ENABLE_CUDA" == "true" ]] && ! command -v nvcc >/dev/null 2>&1; then
    echo "Warning: NVCC not found. CUDA support will be disabled."
    ENABLE_CUDA=false
fi

# æ„å»ºç›®å½•
BUILD_DIR="$ROOT_DIR/build"
INSTALL_DIR="$ROOT_DIR/install"

# æ¸…ç†æ„å»º
if [[ "$CLEAN" == "true" ]] && [[ -d "$BUILD_DIR" ]]; then
    echo "Cleaning build directory..."
    rm -rf "$BUILD_DIR"
fi

# åˆ›å»ºæ„å»ºç›®å½•
mkdir -p "$BUILD_DIR"

# CMake é…ç½®å‚æ•°
CMAKE_ARGS=(
    -G Ninja
    -DCMAKE_BUILD_TYPE="$BUILD_TYPE"
    -DCMAKE_INSTALL_PREFIX="$INSTALL_DIR"
    -DBUILD_TESTS=$([ "$TESTS" == "true" ] && echo "ON" || echo "OFF")
    -DENABLE_CUDA=$([ "$ENABLE_CUDA" == "true" ] && echo "ON" || echo "OFF")
)

# Conan é›†æˆ
if [[ "$USE_CONAN" == "true" ]] && command -v conan >/dev/null 2>&1; then
    echo "Setting up Conan..."
    cd "$ROOT_DIR"
    conan install . --build=missing -pr:b=default
    CMAKE_ARGS+=(-DCMAKE_TOOLCHAIN_FILE="conan_toolchain.cmake")
fi

# é…ç½®
echo "Configuring..."
cd "$BUILD_DIR"
cmake "${CMAKE_ARGS[@]}" "$ROOT_DIR"

# æ„å»º
echo "Building..."
cmake --build . --parallel "$JOBS"

# æµ‹è¯•
if [[ "$TESTS" == "true" ]]; then
    echo "Running tests..."
    ctest --parallel "$JOBS" --output-on-failure || echo "Some tests failed"
fi

# å®‰è£…
echo "Installing..."
cmake --build . --target install

echo "Build completed successfully!"
echo "Install directory: $INSTALL_DIR"
```

### ğŸ”„ CI/CD é›†æˆé…ç½®

#### GitHub Actions å·¥ä½œæµ
```yaml
# .github/workflows/build.yml
name: Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    strategy:
      matrix:
        compiler: [gcc-11, clang-14]
        cuda: [enabled, disabled]
        exclude:
          - compiler: clang-14
            cuda: enabled

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          libboost-all-dev \
          libyaml-cpp-dev \
          libspdlog-dev \
          libglfw3-dev \
          libglew-dev \
          libeigen3-dev

    - name: Install CUDA
      if: matrix.cuda == 'enabled'
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '12.2'

    - name: Setup compiler
      run: |
        if [[ "${{ matrix.compiler }}" == "gcc-11" ]]; then
          echo "CC=gcc-11" >> $GITHUB_ENV
          echo "CXX=g++-11" >> $GITHUB_ENV
        elif [[ "${{ matrix.compiler }}" == "clang-14" ]]; then
          echo "CC=clang-14" >> $GITHUB_ENV
          echo "CXX=clang++-14" >> $GITHUB_ENV
        fi

    - name: Configure CMake
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
          -DBUILD_TESTS=ON \
          -DENABLE_CUDA=${{ matrix.cuda == 'enabled' && 'ON' || 'OFF' }}

    - name: Build
      run: cmake --build build --parallel $(nproc)

    - name: Test
      working-directory: build
      run: ctest --parallel $(nproc) --output-on-failure

  build-windows:
    runs-on: windows-2022

    steps:
    - uses: actions/checkout@v4

    - name: Install vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git
        .\vcpkg\bootstrap-vcpkg.bat
        echo "VCPKG_ROOT=$PWD\vcpkg" >> $env:GITHUB_ENV

    - name: Install CUDA
      uses: Jimver/cuda-toolkit@v0.2.11
      with:
        cuda: '12.2'

    - name: Install dependencies
      run: |
        .\vcpkg\vcpkg install boost yaml-cpp spdlog glfw3 glew eigen3 --triplet x64-windows

    - name: Configure CMake
      run: |
        cmake -B build `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
          -DBUILD_TESTS=ON `
          -DENABLE_CUDA=ON

    - name: Build
      run: cmake --build build --config $env:BUILD_TYPE --parallel

    - name: Test
      working-directory: build
      run: ctest --config $env:BUILD_TYPE --parallel --output-on-failure
```

---

## å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ       | ä¿®æ”¹äºº | å˜æ›´æ‘˜è¦                         |
| :--- | :--------- | :----- | :------------------------------- |
| v1.0 | 2025-09-10 | Kelin  | åˆ›å»ºæ„å»ºç³»ç»Ÿé…ç½®æ–‡æ¡£å’Œè‡ªåŠ¨åŒ–è„šæœ¬ |
