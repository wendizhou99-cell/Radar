# 开发环境配置

- **标题**: AI协作开发环境标准化配置指南
- **当前版本**: v1.0
- **最后更新**: 2025-09-10
- **负责人**: Kelin

---

## 支持的操作系统

### 🖥️ Windows 环境
#### 系统要求
- **操作系统**: Windows 10 20H2+ 或 Windows 11
- **架构**: x64 (必需), ARM64 (实验性支持)
- **内存**: 最低 16GB，推荐 32GB
- **存储**: 至少 50GB 可用空间 (SSD推荐)

#### 必需组件安装
```powershell
# 1. 安装 Chocolatey 包管理器
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

# 2. 安装开发工具链
choco install -y git cmake ninja visualstudio2022buildtools
choco install -y visualstudio2022-workload-vctools
choco install -y cuda --version=12.2.0

# 3. 安装 VS Code 和扩展
choco install -y vscode
code --install-extension ms-vscode.cpptools
code --install-extension ms-vscode.cmake-tools
code --install-extension nvidia.nsight-vscode-edition
```

#### 环境变量配置
```cmd
# CUDA 环境变量
set CUDA_PATH=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.2
set CUDA_PATH_V12_2=C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.2

# 添加到 PATH
set PATH=%CUDA_PATH%\bin;%CUDA_PATH%\libnvvp;%PATH%

# CMake 配置
set CMAKE_GENERATOR=Ninja
set CMAKE_CUDA_COMPILER=%CUDA_PATH%\bin\nvcc.exe
```

### 🐧 Linux 环境 (Ubuntu 22.04 LTS 推荐)
#### 系统要求
- **发行版**: Ubuntu 22.04 LTS, CentOS Stream 9, 或 RHEL 9
- **内核版本**: 5.15+ (推荐 6.2+)
- **架构**: x86_64 (必需), aarch64 (实验性支持)
- **内存**: 最低 16GB，推荐 32GB

#### 一键安装脚本
```bash
#!/bin/bash
# scripts/setup_ubuntu_dev_env.sh

set -e

echo "=== 雷达系统开发环境自动安装 ==="

# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础开发工具
sudo apt install -y \
    build-essential \
    cmake \
    ninja-build \
    git \
    curl \
    wget \
    pkg-config \
    software-properties-common

# 安装编译器
sudo apt install -y \
    gcc-11 \
    g++-11 \
    clang-14 \
    clang++-14

# 设置默认编译器
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 100
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 100

# 安装 CUDA (如果有 NVIDIA GPU)
if lspci | grep -i nvidia > /dev/null; then
    echo "检测到 NVIDIA GPU，安装 CUDA..."

    # 添加 NVIDIA 官方源
    wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin
    sudo mv cuda-ubuntu2204.pin /etc/apt/preferences.d/cuda-repository-pin-600

    wget https://developer.download.nvidia.com/compute/cuda/12.2.0/local_installers/cuda-repo-ubuntu2204-12-2-local_12.2.0-535.54.03-1_amd64.deb
    sudo dpkg -i cuda-repo-ubuntu2204-12-2-local_12.2.0-535.54.03-1_amd64.deb
    sudo cp /var/cuda-repo-ubuntu2204-12-2-local/cuda-*-keyring.gpg /usr/share/keyrings/

    sudo apt update
    sudo apt install -y cuda-toolkit-12-2

    # 配置环境变量
    echo 'export PATH=/usr/local/cuda-12.2/bin:$PATH' >> ~/.bashrc
    echo 'export LD_LIBRARY_PATH=/usr/local/cuda-12.2/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
    echo 'export CUDA_HOME=/usr/local/cuda-12.2' >> ~/.bashrc
fi

# 安装第三方库
sudo apt install -y \
    libboost-all-dev \
    libyaml-cpp-dev \
    libgtest-dev \
    libgmock-dev \
    libglfw3-dev \
    libglew-dev \
    libopengl-dev

# 安装 VS Code (可选)
if ! command -v code &> /dev/null; then
    echo "安装 VS Code..."
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > packages.microsoft.gpg
    sudo install -o root -g root -m 644 packages.microsoft.gpg /etc/apt/trusted.gpg.d/
    echo "deb [arch=amd64,arm64,armhf signed-by=/etc/apt/trusted.gpg.d/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main" | sudo tee /etc/apt/sources.list.d/vscode.list

    sudo apt update
    sudo apt install -y code

    # 安装 VS Code 扩展
    code --install-extension ms-vscode.cpptools
    code --install-extension ms-vscode.cmake-tools
    code --install-extension nvidia.nsight-vscode-edition
fi

echo "✅ 开发环境安装完成！"
echo "请运行 'source ~/.bashrc' 重新加载环境变量"
```

### 🍎 macOS 环境 (实验性支持)
#### 系统要求
- **版本**: macOS 12.0+ (Monterey)
- **架构**: Intel x64 或 Apple Silicon (M1/M2)
- **内存**: 最低 16GB，推荐 32GB

#### 安装步骤
```bash
# 1. 安装 Homebrew
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# 2. 安装开发工具
brew install cmake ninja boost yaml-cpp googletest
brew install --cask visual-studio-code

# 3. 安装 Xcode 命令行工具
xcode-select --install

# 注意：macOS 不支持 CUDA，GPU 功能将被禁用
```

---

## 编译器配置

### 🔧 GCC 配置 (Linux 主要选择)
#### 版本要求
- **最低版本**: GCC 9.0
- **推荐版本**: GCC 11+
- **最新测试版本**: GCC 12.2

#### 编译选项配置
```bash
# ~/.bashrc 或项目级配置
export CC=gcc-11
export CXX=g++-11

# CMake 配置
export CMAKE_C_COMPILER=gcc-11
export CMAKE_CXX_COMPILER=g++-11

# 编译标志
export CXXFLAGS="-std=c++17 -O2 -Wall -Wextra -march=native"
export CFLAGS="-O2 -Wall -Wextra -march=native"
```

### 🛠️ Clang 配置 (备用选择)
#### 版本要求
- **最低版本**: Clang 12.0
- **推荐版本**: Clang 14+
- **最新测试版本**: Clang 15.0

#### 配置示例
```bash
# 使用 Clang
export CC=clang-14
export CXX=clang++-14
export CMAKE_C_COMPILER=clang-14
export CMAKE_CXX_COMPILER=clang++-14

# Clang 特定选项
export CXXFLAGS="-std=c++17 -O2 -Wall -Wextra -stdlib=libc++"
```

### 🏢 MSVC 配置 (Windows)
#### 版本要求
- **最低版本**: MSVC 19.28 (VS 2019 16.8+)
- **推荐版本**: MSVC 19.30+ (VS 2022)

#### 配置脚本
```cmd
REM 设置 VS 2022 环境
call "C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Auxiliary\Build\vcvars64.bat"

REM CMake 配置
set CMAKE_GENERATOR=Visual Studio 17 2022
set CMAKE_GENERATOR_PLATFORM=x64
```

---

## 开发工具配置

### 📝 VS Code 配置
#### 推荐扩展列表
```json
{
  "recommendations": [
    "ms-vscode.cpptools",
    "ms-vscode.cmake-tools",
    "ms-vscode.cpptools-extension-pack",
    "nvidia.nsight-vscode-edition",
    "twxs.cmake",
    "ms-vscode.hexeditor",
    "eamodio.gitlens",
    "ms-python.python",
    "yzhang.markdown-all-in-one",
    "shd101wyy.markdown-preview-enhanced"
  ]
}
```

#### 工作区配置 (.vscode/settings.json)
```json
{
    "C_Cpp.default.configurationProvider": "ms-vscode.cmake-tools",
    "C_Cpp.default.cppStandard": "c++17",
    "C_Cpp.default.intelliSenseMode": "gcc-x64",
    "cmake.configureOnOpen": true,
    "cmake.buildDirectory": "${workspaceFolder}/build",
    "cmake.generator": "Ninja",
    "cmake.configureArgs": [
        "-DCMAKE_BUILD_TYPE=Debug",
        "-DCMAKE_EXPORT_COMPILE_COMMANDS=ON"
    ],
    "files.associations": {
        "*.cu": "cuda-cpp",
        "*.cuh": "cuda-cpp"
    },
    "editor.formatOnSave": true,
    "C_Cpp.formatting": "clangFormat",
    "C_Cpp.clang_format_style": "file"
}
```

#### 调试配置 (.vscode/launch.json)
```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Debug Radar Application",
            "type": "cppdbg",
            "request": "launch",
            "program": "${workspaceFolder}/build/bin/radar_application",
            "args": ["--config", "${workspaceFolder}/configs/debug_config.yaml"],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [
                {
                    "name": "CUDA_VISIBLE_DEVICES",
                    "value": "0"
                }
            ],
            "externalConsole": false,
            "MIMode": "gdb",
            "setupCommands": [
                {
                    "description": "Enable pretty-printing for gdb",
                    "text": "-enable-pretty-printing",
                    "ignoreFailures": true
                }
            ],
            "preLaunchTask": "cmake: build"
        },
        {
            "name": "Debug Unit Tests",
            "type": "cppdbg",
            "request": "launch",
            "program": "${workspaceFolder}/build/bin/radar_tests",
            "args": ["--gtest_filter=*", "--gtest_output=xml:test_results.xml"],
            "stopAtEntry": false,
            "cwd": "${workspaceFolder}",
            "environment": [],
            "externalConsole": false,
            "MIMode": "gdb"
        }
    ]
}
```

### 🔧 CLion 配置 (可选)
#### 项目设置
```cmake
# CLion 特定的 CMake 选项
set(CMAKE_BUILD_TYPE Debug)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# 启用 CLion 的代码分析
set(CMAKE_CXX_CLANG_TIDY clang-tidy)
```

#### 代码风格配置
```xml
<!-- .idea/codeStyles/Project.xml -->
<component name="ProjectCodeStyleConfiguration">
  <code_scheme name="Project" version="173">
    <Objective-C-extensions>
      <file>
        <option name="com.jetbrains.cidr.lang.util.OCDeclarationKind" value="Import" />
      </file>
    </Objective-C-extensions>
  </code_scheme>
</component>
```

---

## 调试环境配置

### 🐛 GDB 配置
#### .gdbinit 配置
```gdb
# ~/.gdbinit
set print pretty on
set print object on
set print static-members on
set print vtbl on
set print demangle on
set demangle-style gnu-v3
set print sevenbit-strings off

# CUDA 调试支持
set cuda memcheck on
set cuda api_failures stop

# 自动加载项目符号
add-auto-load-safe-path /path/to/radar/project
```

#### CUDA 调试配置
```bash
# CUDA 调试环境变量
export CUDA_DEBUGGER_SOFTWARE_PREEMPTION=1
export CUDA_MEMCHECK=1

# 使用 cuda-gdb
alias cuda-debug='cuda-gdb --args'
```

### 🔍 Valgrind 配置
#### 内存检查配置
```bash
# scripts/run_valgrind.sh
#!/bin/bash

valgrind \
    --tool=memcheck \
    --leak-check=full \
    --show-leak-kinds=all \
    --track-origins=yes \
    --verbose \
    --log-file=valgrind_report.txt \
    ./build/bin/radar_application
```

### 📊 性能分析工具
#### 集成性能分析
```bash
# 使用 perf 进行性能分析
perf record -g ./build/bin/radar_application
perf report

# 使用 NVIDIA Nsight Systems
nsys profile -o radar_profile ./build/bin/radar_application

# 使用 NVIDIA Nsight Compute (GPU kernels)
ncu -o radar_kernel_profile ./build/bin/radar_application
```

---

## 环境验证

### ✅ 环境检查脚本
```bash
#!/bin/bash
# scripts/verify_dev_environment.sh

echo "=== 雷达系统开发环境验证 ==="

# 检查编译器
echo "检查编译器版本..."
gcc --version | head -1
g++ --version | head -1

# 检查 CMake
echo "检查 CMake..."
cmake --version | head -1

# 检查 CUDA (如果可用)
if command -v nvcc &> /dev/null; then
    echo "检查 CUDA..."
    nvcc --version | grep release
    nvidia-smi | head -3
else
    echo "⚠️  CUDA 不可用 - GPU 功能将被禁用"
fi

# 检查第三方库
echo "检查第三方库..."
pkg-config --modversion yaml-cpp 2>/dev/null || echo "❌ yaml-cpp 未找到"
pkg-config --modversion glfw3 2>/dev/null || echo "❌ GLFW 未找到"

# 检查 Boost
if [ -f /usr/include/boost/version.hpp ]; then
    BOOST_VERSION=$(grep BOOST_LIB_VERSION /usr/include/boost/version.hpp | cut -d'"' -f2)
    echo "✅ Boost 版本: $BOOST_VERSION"
else
    echo "❌ Boost 未找到"
fi

# 测试编译
echo "测试编译..."
cat > test_compile.cpp << 'EOF'
#include <iostream>
#include <memory>
#include <vector>

int main() {
    auto vec = std::make_unique<std::vector<int>>(10, 42);
    std::cout << "C++17 编译测试成功！" << std::endl;
    return 0;
}
EOF

if g++ -std=c++17 -o test_compile test_compile.cpp 2>/dev/null; then
    echo "✅ C++17 编译测试通过"
    ./test_compile
    rm -f test_compile test_compile.cpp
else
    echo "❌ C++17 编译测试失败"
fi

echo "=== 环境验证完成 ==="
```

### 🔧 配置修复脚本
```bash
#!/bin/bash
# scripts/fix_environment.sh

echo "=== 自动修复环境配置问题 ==="

# 修复常见的库路径问题
if [ -d /usr/local/cuda ]; then
    echo "修复 CUDA 库路径..."
    echo 'export PATH=/usr/local/cuda/bin:$PATH' >> ~/.bashrc
    echo 'export LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH' >> ~/.bashrc
fi

# 修复编译器链接
if command -v g++-11 &> /dev/null && ! command -v g++ &> /dev/null; then
    echo "创建编译器软链接..."
    sudo ln -sf /usr/bin/g++-11 /usr/bin/g++
    sudo ln -sf /usr/bin/gcc-11 /usr/bin/gcc
fi

# 修复包管理器问题
if command -v apt &> /dev/null; then
    echo "修复 apt 源..."
    sudo apt update --fix-missing
fi

echo "✅ 环境修复完成，请重启终端或运行 'source ~/.bashrc'"
```

---

## 常见问题排查

### ❓ 编译器问题
```markdown
## 问题：找不到编译器
**症状**：cmake 提示找不到 C++ 编译器
**解决方案**：
1. 确认编译器已安装：`g++ --version`
2. 设置 CMake 编译器：`export CMAKE_CXX_COMPILER=g++`
3. 重新配置：`cmake -B build -S .`

## 问题：C++17 特性不支持
**症状**：编译时提示 C++17 特性不可用
**解决方案**：
1. 检查编译器版本：`g++ --version` (需要 GCC 9+)
2. 确认 CMake 配置：`set(CMAKE_CXX_STANDARD 17)`
3. 手动指定：`g++ -std=c++17`
```

### ❓ CUDA 问题
```markdown
## 问题：CUDA 编译失败
**症状**：nvcc 编译报错或找不到 CUDA 库
**解决方案**：
1. 检查 CUDA 安装：`nvcc --version`
2. 验证驱动兼容性：`nvidia-smi`
3. 设置环境变量：
   ```bash
   export CUDA_HOME=/usr/local/cuda
   export PATH=$CUDA_HOME/bin:$PATH
   export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
   ```

## 问题：GPU 内存不足
**症状**：CUDA 运行时报告内存不足
**解决方案**：
1. 检查 GPU 内存：`nvidia-smi`
2. 减少批处理大小
3. 启用内存池：设置 `CUDA_MEMORY_POOL_TYPE=chunked`
```

### ❓ 依赖库问题
```markdown
## 问题：找不到 Boost 库
**症状**：CMake 无法找到 Boost
**解决方案**：
1. 安装 Boost：`sudo apt install libboost-all-dev`
2. 指定路径：`cmake -DBOOST_ROOT=/usr/local/boost`
3. 使用 vcpkg：`vcpkg install boost`

## 问题：OpenGL 库缺失
**症状**：图形功能编译失败
**解决方案**：
1. 安装 OpenGL 开发库：`sudo apt install libopengl-dev`
2. 安装 GLFW：`sudo apt install libglfw3-dev`
3. 安装 GLEW：`sudo apt install libglew-dev`
```

---

## 变更记录

| 版本 | 日期       | 修改人 | 变更摘要             |
| :--- | :--------- | :----- | :------------------- |
| v1.0 | 2025-09-10 | Kelin  | 创建开发环境配置指南 |
