# 意图澄清协议

- **标题**: AI主动询问和澄清机制协议
- **当前版本**: v1.0
- **最后更新**: 2025-09-10
- **负责人**: Kelin

---

## 澄清触发条件

### 🚨 强制澄清条件 (AI必须主动询问)

#### 1. 技术选择不明确
**触发场景**:
- 用户提到"处理数据"但未说明CPU或GPU处理
- 用户提到"快速处理"但未给出具体性能指标
- 用户提到"存储结果"但未说明存储格式和位置

**标准判断**:
```markdown
如果用户描述中包含以下模糊表达，AI必须澄清：
- "处理" → 需明确：同步/异步、CPU/GPU、批处理/流式
- "快速" → 需明确：具体延迟要求（毫秒级数值）
- "存储" → 需明确：存储位置、格式、持久性要求
- "接口" → 需明确：输入输出类型、错误处理方式
- "优化" → 需明确：优化目标（延迟/吞吐量/内存）
```

#### 2. 性能要求模糊
**触发条件**:
- 使用非量化的性能描述："快速"、"高效"、"实时"
- 缺少关键性能指标：延迟、吞吐量、内存使用
- 性能约束不明确：硬件限制、并发要求

**必须澄清的指标**:
```markdown
延迟要求：
- 最大可接受延迟（毫秒）
- 平均期望延迟（毫秒）
- 延迟抖动的可接受范围

吞吐量要求：
- 每秒处理的数据包数量
- 峰值处理能力要求
- 持续处理能力要求

资源限制：
- GPU内存使用上限
- CPU使用率限制
- 系统总内存限制
```

#### 3. 接口定义不完整
**触发条件**:
- 只说明功能但未定义接口签名
- 缺少错误处理机制说明
- 未说明数据格式和约束条件

**必须澄清的接口要素**:
```markdown
输入接口：
- 参数类型和约束条件
- 可选参数的默认值
- 输入数据的有效性检查

输出接口：
- 返回值类型和含义
- 成功和失败的判断标准
- 输出数据的格式和精度

错误处理：
- 异常情况的处理方式
- 错误信息的返回格式
- 错误恢复的策略
```

### ⚠️ 建议澄清条件 (AI应该主动询问)

#### 1. 实现细节不明确
- 算法选择有多种可能性
- 数据结构设计有不同方案
- 优化策略需要权衡选择

#### 2. 集成方式不清楚
- 与现有模块的交互方式
- 配置参数的来源和格式
- 初始化和清理的时机

#### 3. 测试要求不明确
- 测试数据的准备方式
- 测试覆盖率的要求
- 性能基准的设定标准

---

## 标准澄清流程

### 📋 第一阶段：信息收集

**AI执行步骤**:
1. **识别不明确的要素**
   - 扫描用户需求，识别模糊描述
   - 对照项目规范，找出缺失信息
   - 分析技术实现的关键决策点

2. **分类澄清需求**
   ```markdown
   技术选择类：CPU vs GPU、同步 vs 异步等
   性能要求类：延迟、吞吐量、资源使用限制
   接口设计类：输入输出格式、错误处理机制
   集成方式类：模块依赖、配置方式、调用时机
   ```

3. **准备澄清问题**
   - 使用 `prompt模板库.md` 中的澄清模板
   - 按优先级排列问题（强制 > 建议）
   - 准备具体的选项供用户选择

### 🔍 第二阶段：主动询问

**询问原则**:
- **一次性询问**: 尽量在一轮对话中询问所有关键问题
- **结构化提问**: 按类别组织问题，便于用户理解和回答
- **提供选项**: 给出具体的技术选项，而非开放式问题

**标准询问格式**:
```markdown
我需要澄清以下关键信息以确保准确实现：

【技术选择】（必须明确）
1. 数据处理方式：
   a) CPU多线程处理
   b) GPU并行计算处理
   c) CPU+GPU混合处理

2. 处理模式：
   a) 同步处理（阻塞等待结果）
   b) 异步处理（非阻塞，回调通知）
   c) 流水线处理（边处理边输出）

【性能要求】（必须量化）
1. 延迟要求：预期的最大处理延迟是多少毫秒？
2. 吞吐量：每秒需要处理多少个数据包？
3. 内存限制：GPU内存使用的上限是多少GB？

【接口设计】（必须明确）
1. 输入数据格式：是使用RawDataPacket结构吗？
2. 输出数据格式：需要包含哪些处理结果字段？
3. 错误处理：倾向于异常机制还是错误码机制？

【可选澄清】
1. 配置方式：是否需要配置文件支持参数调整？
2. 日志级别：需要详细的调试日志还是简单的状态日志？
```

### ✅ 第三阶段：确认理解

**确认步骤**:
1. **总结用户回答**
   ```markdown
   基于您的回答，我理解的技术方案是：
   - 使用GPU并行处理，异步模式
   - 处理延迟目标<10ms，吞吐量>1000包/秒
   - 输入RawDataPacket，输出ProcessedData
   - 使用错误码机制，支持配置文件

   请确认这个理解是否正确？
   ```

2. **识别可能的冲突**
   - 检查技术选择之间是否兼容
   - 验证性能要求是否现实可达
   - 确认接口设计是否完整

3. **获得最终确认**
   - 等待用户明确确认理解正确
   - 如有不同意见，重新澄清具体点
   - 记录最终确认的技术方案

---

## 澄清问题分类

### 🔧 技术实现类澄清

#### 算法选择澄清
```markdown
关于[具体算法需求]，有以下实现选择：

a) 基于FFT的频域处理算法
   - 优点：处理速度快，适合大批量数据
   - 缺点：内存使用较高，延迟相对较大

b) 基于时域滤波的算法
   - 优点：延迟低，内存使用少
   - 缺点：计算复杂度高，适合小批量数据

c) 混合算法（小数据时域，大数据频域）
   - 优点：兼顾延迟和吞吐量
   - 缺点：实现复杂度较高

您更倾向于哪种方案？或者有其他性能优先级考虑？
```

#### 数据结构澄清
```markdown
关于数据存储结构，需要确认：

内存布局：
- 按行存储（便于CPU访问）
- 按列存储（便于GPU并行处理）
- 块存储（兼顾CPU和GPU效率）

数据精度：
- float32（标准精度，兼容性好）
- float64（高精度，计算量大）
- int16（节省内存，精度有限）

缓存策略：
- 单缓冲（简单，延迟可能较高）
- 双缓冲（平衡延迟和复杂度）
- 环形缓冲（低延迟，实现复杂）
```

### ⚡ 性能优化类澄清

#### 性能优先级澄清
```markdown
在性能优化中，请排列以下指标的优先级：

1. 处理延迟（单个数据包的处理时间）
2. 系统吞吐量（整体处理能力）
3. 内存使用效率（RAM和GPU内存）
4. CPU利用率（多核使用效率）
5. GPU利用率（并行计算效率）

最重要的前3个指标是？
如果有冲突，哪个指标不能妥协？
```

#### 资源限制澄清
```markdown
关于系统资源限制：

硬件约束：
- GPU型号和计算能力：[请提供具体型号]
- 可用GPU内存：[请提供具体容量]
- CPU核心数和频率：[请提供具体配置]

软件约束：
- 是否有其他程序同时使用GPU？
- 系统内存的可用量和限制？
- 是否有实时性硬性要求？

并发要求：
- 同时处理的最大任务数？
- 是否需要支持多客户端？
```

### 🔌 接口集成类澄清

#### 模块交互澄清
```markdown
关于与其他模块的交互：

上游模块（数据来源）：
- 数据来源模块：[具体模块名]
- 数据传递方式：共享内存/消息队列/直接调用
- 数据到达频率和批量大小

下游模块（数据消费者）：
- 结果接收模块：[具体模块名]
- 结果通知方式：回调/轮询/事件驱动
- 结果格式要求和时效性

错误处理：
- 上游数据异常时的处理策略
- 处理失败时对下游的通知方式
- 系统级错误的恢复机制
```

#### 配置管理澄清
```markdown
关于配置和参数管理：

配置来源：
- 配置文件（YAML/JSON/XML）
- 环境变量
- 运行时参数传递
- 数据库配置

配置内容：
- 算法参数（阈值、系数等）
- 性能参数（批大小、线程数等）
- 资源限制（内存上限、超时时间等）
- 调试选项（日志级别、性能监控等）

配置更新：
- 是否支持运行时配置更新？
- 配置变更时是否需要重启？
- 配置校验和错误处理机制？
```

---

## 澄清完成标准

### ✅ 完成标准检查清单

#### 技术方案明确 ☐
- [ ] 核心算法和数据结构已选定
- [ ] 处理方式（CPU/GPU/混合）已确定
- [ ] 性能优化策略已明确
- [ ] 并发和线程模型已确定

#### 接口设计完整 ☐
- [ ] 输入参数类型和约束已定义
- [ ] 输出结果格式和内容已明确
- [ ] 错误处理机制已设计
- [ ] 生命周期管理策略已确定

#### 性能要求量化 ☐
- [ ] 延迟要求有具体数值（毫秒）
- [ ] 吞吐量要求有具体数值（包/秒）
- [ ] 资源使用限制有具体数值（GB、%）
- [ ] 性能优先级已明确排序

#### 集成方案明确 ☐
- [ ] 依赖模块和接口已确认
- [ ] 配置方式和参数来源已确定
- [ ] 初始化和清理流程已设计
- [ ] 错误传播和恢复机制已明确

### 🎯 质量验证标准

#### 一致性检查
```markdown
技术选择一致性：
- GPU处理 + 实时要求 → 需要验证GPU延迟特性
- 异步处理 + 严格时序 → 需要确认时序保证机制
- 高吞吐量 + 低内存 → 需要权衡批处理大小

性能要求合理性：
- 延迟要求是否在硬件能力范围内
- 吞吐量要求是否与算法复杂度匹配
- 资源限制是否与功能需求兼容
```

#### 完整性检查
```markdown
功能覆盖完整性：
- 正常处理流程已定义
- 异常情况处理已考虑
- 边界条件处理已设计
- 资源管理策略已明确

接口覆盖完整性：
- 数据输入接口完整
- 结果输出接口完整
- 控制管理接口完整
- 状态查询接口完整
```

---

## 用户响应指南

### 📝 高效回答技巧

#### 结构化回答
```markdown
推荐的回答格式：

【技术选择】
- 处理方式：GPU并行处理
- 处理模式：异步处理
- 算法选择：基于FFT的频域处理

【性能要求】
- 最大延迟：10ms
- 目标吞吐量：1000包/秒
- GPU内存限制：2GB

【接口要求】
- 输入：RawDataPacket结构
- 输出：ProcessedData结构，包含幅度和相位信息
- 错误处理：返回错误码，详细信息记录日志

【特殊要求】
- 需要支持配置文件动态调整参数
- 需要性能监控和统计信息输出
```

#### 优先级回答
```markdown
如果一次回答所有问题困难，请按优先级回答：

优先级1（必须回答）：
- 技术选择类问题
- 关键性能指标
- 核心接口定义

优先级2（建议回答）：
- 配置和管理机制
- 调试和监控需求
- 优化策略偏好

可以分两轮回答，AI会根据优先级1的回答先开始设计核心方案。
```

### ❓ 不确定时的处理

#### 坦诚表达不确定
```markdown
如果对某些技术细节不确定，请坦诚表达：

"我对GPU内存的具体限制不太确定，但希望系统能在2GB GPU的环境中正常运行"

"延迟要求我需要进一步评估，能否先按10ms设计，后续根据测试结果调整？"

"错误处理机制我倾向于使用错误码，但如果异常机制更合适，我可以接受"
```

#### 请求建议和权衡
```markdown
可以向AI请求技术建议：

"在延迟和吞吐量之间，哪个更容易优化？请给出建议和理由"

"对于这种数据特征，GPU处理相比CPU处理有多大优势？"

"异步处理会增加多少实现复杂度？是否值得？"
```

---

## 常见澄清场景

### 🎯 典型场景1：性能要求模糊

**用户原始需求**:
> "我要一个快速的数据处理模块"

**AI澄清过程**:
```markdown
您提到需要"快速"的数据处理，我需要明确具体的性能指标：

【延迟要求】
- 单个数据包的处理延迟期望是多少毫秒？
- 最大可接受的延迟是多少？

【吞吐量要求】
- 预期每秒需要处理多少个数据包？
- 峰值处理能力需要达到多少？

【处理方式】
- 倾向于GPU加速处理还是CPU多线程处理？
- 是否接受异步处理以提高吞吐量？

【资源约束】
- GPU内存使用的上限是多少？
- 是否有CPU使用率的限制？
```

### 🎯 典型场景2：接口定义不完整

**用户原始需求**:
> "实现一个数据处理接口"

**AI澄清过程**:
```markdown
关于数据处理接口，需要明确以下细节：

【输入接口】
- 输入数据的类型：是RawDataPacket吗？
- 输入参数：除了数据外，是否需要处理选项参数？
- 数据约束：输入数据的大小范围和格式要求？

【输出接口】
- 输出数据的类型：ProcessedData结构还是其他格式？
- 输出内容：需要包含哪些处理结果（幅度、相位、统计信息等）？
- 输出方式：直接返回、填充输出参数，还是回调通知？

【错误处理】
- 错误报告方式：异常、错误码，还是状态对象？
- 错误详细信息：是否需要详细的错误描述和位置信息？
- 错误恢复：是否支持错误后的状态恢复？

【生命周期】
- 接口对象的创建和销毁时机？
- 是否需要初始化和清理方法？
- 并发调用的安全性要求？
```

### 🎯 典型场景3：技术选择冲突

**用户原始需求**:
> "需要实时处理，同时要高吞吐量"

**AI澄清过程**:
```markdown
您提到了"实时处理"和"高吞吐量"，这两个要求可能存在权衡：

【实时性要求明确】
- "实时"的具体含义：硬实时（绝对不能超时）还是软实时（偶尔可超时）？
- 可接受的最大延迟：毫秒级的具体数值？
- 延迟抖动的容忍度：是否要求稳定的延迟？

【吞吐量要求明确】
- 目标吞吐量：每秒多少个数据包？
- 是否可以接受批处理以提高吞吐量？
- 在延迟和吞吐量冲突时，哪个优先级更高？

【技术方案建议】
基于经验，可能的解决方案：
a) 优先延迟：小批量处理，可能牺牲部分吞吐量
b) 优先吞吐量：较大批量处理，延迟可能增加
c) 混合方案：根据数据量动态调整批大小

您倾向于哪种方案？
```

---

## 变更记录

| 版本 | 日期       | 修改人 | 变更摘要         |
| :--- | :--------- | :----- | :--------------- |
| v1.0 | 2025-09-10 | Kelin  | 创建意图澄清协议 |
