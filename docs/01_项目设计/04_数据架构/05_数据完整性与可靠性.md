# 数据完整性与可靠性

  - **当前版本**: v1.0.0
  - **最后更新**: 2025-10-15
  - **负责人**: Klein

-----

## 概述

  - **概要**: 本文件是数据架构的“**质量保障手册**”和“**保险单**”。它的核心职责是，在系统选择了以性能优先的UDP协议作为数据面传输方式后，定义一套应用层的机制，来弥补其固有的不可靠性，确保数据的完整性（Integrity）和一定程度的可靠性（Reliability）。本文档为`显控终端应用`实现“网络丢包容忍度”KPI提供了具体的技术实现路径。

-----

## 目录

- [数据完整性与可靠性](#数据完整性与可靠性)
  - [概述](#概述)
  - [目录](#目录)
  - [1 文档职责](#1-文档职责)
    - [1.1 文档目标](#11-文档目标)
    - [1.2 核心原则对齐](#12-核心原则对齐)
  - [2 丢包检测：序列号机制](#2-丢包检测序列号机制)
    - [2.1 职责定义](#21-职责定义)
    - [2.2 客户端实现逻辑](#22-客户端实现逻辑)
    - [2.3 边界情况处理](#23-边界情况处理)
  - [3 数据损坏检测：校验和机制](#3-数据损坏检测校验和机制)
    - [3.1 需求分析](#31-需求分析)
    - [3.2 技术选型](#32-技术选型)
    - [3.3 协议扩展 (`.proto`)](#33-协议扩展-proto)
    - [3.4 实现指南](#34-实现指南)
  - [4 未来演进：可靠性增强策略](#4-未来演进可靠性增强策略)
    - [4.1 场景分析](#41-场景分析)
    - [4.2 NACK机制概念设计](#42-nack机制概念设计)
    - [4.3 复杂性与声明](#43-复杂性与声明)
  - [5 术语表](#5-术语表)
  - [6 相关文档](#6-相关文档)
  - [7 变更历史](#7-变更历史)

-----

## 1 文档职责

  - **概要**: 本章定义了本文档自身的“使命”，明确其目标、范围以及设计所遵循的核心架构原则，确保本设计与系统整体架构保持一致。

### 1.1 文档目标

  - **概要**: 本节旨在清晰界定本文档要讲什么、不讲什么，为读者设定正确的预期。
      - **目标**:
          - 详细阐述基于`batch_sequence_id`的**应用层丢包检测机制**的服务器端生成与客户端检测逻辑。
          - 设计并引入一种**端到端应用层校验和机制**（如CRC32c），以保障数据在传输过程中免于损坏。
          - 为未来可能需要的更高可靠性传输（如NACK重传）提供**前瞻性的概念设计**和技术储备。

### 1.2 核心原则对齐

  - **概要**: 本节旨在确保本文档所有设计决策都与项目已确立的架构原则完全对齐。

| 核心原则 | 在本设计中的具体体现 |
| :--- | :--- |
| **数据与控制分离** | 本文档定义的可靠性机制（序列号、校验和）完全封装在**数据面**的`TrackDataBatch`消息中。未来规划的NACK重传请求，则明确通过**控制面**的RESTful API发起，严格遵循了两平面的职责划分。 |
| **全链路可观测性** | 客户端在检测到丢包或校验和错误时，**必须**记录包含源IP、端口等上下文信息的日志。这些日志与服务器端的`TraceID`日志相结合，为网络问题的端到端诊断提供了关键数据。 |
| **接口驱动开发** | 本文档对`track_data.proto`的扩展（如增加`checksum`字段），是对服务器与客户端之间**数据契约**的正式修订。双方的实现都必须以此为依据，确保接口的明确性和一致性。 |

-----

## 2 丢包检测：序列号机制

  - **概要**: 本章是文档的核心和基础，详细阐述已在系统中设计的`batch_sequence_id`机制，它是客户端实现UDP丢包检测的唯一依据。

### 2.1 职责定义

  - **概要**: 本节明确服务器端与客户端在序列号机制中的各自职责。
      - **服务器端 (`DisplayController`)**: **必须**在发送每个`TrackDataBatch`之前，为其分配一个全局单调递增的`uint64`序列号。
      - **客户端 (`ClientApp`)**: **必须**负责检测序列号的间隙，并据此判断是否发生了数据包丢失。

### 2.2 客户端实现逻辑

  - **概要**: 本节提供清晰的伪代码或流程图，描述客户端的丢包检测与乱序处理逻辑。

### 2.3 边界情况处理

  - **概要**: 本节讨论在实现序列号检测时需要考虑的边界情况，以体现设计的严谨性。

-----

## 3 数据损坏检测：校验和机制

  - **概要**: 本章引入一种应用层校验和机制，作为端到端数据完整性的最后一道防线，以应对网络传输中可能发生的位错误。

### 3.1 需求分析

  - **概要**: 本节解释**为什么**需要应用层校验和，尽管UDP协议头已包含校验和。

### 3.2 技术选型

  - **概要**: 本节对校验和算法进行选型，并阐明理由。

### 3.3 协议扩展 (`.proto`)

  - **概要**: 本节提出对`track_data.proto`文件进行扩展，以支持校验和字段。

### 3.4 实现指南

  - **概要**: 本节为服务器端（生成）和客户端（验证）提供正确计算和校验Checksum的关键步骤指导。

-----

## 4 未来演进：可靠性增强策略

  - **概要**: 本章遵循项目演进规划，为未来可能需要的更高可靠性传输提供前瞻性设计思路。

### 4.1 场景分析

  - **概要**: 本节讨论在哪些特定业务场景下，简单的丢包检测可能不足，可能需要保证关键信息的可靠送达。

### 4.2 NACK机制概念设计

  - **概要**: 本节简要勾勒一个基于否定应答（Negative Acknowledgment, NACK）的应用层重传机制的概念设计。

### 4.3 复杂性与声明

  - **概要**: 本节明确指出，引入NACK等可靠性机制会显著增加系统复杂性，因此在当前及近期版本中**不予实现**，仅作为未来的技术储备。

-----

## 5 术语表

| 术语 / 英文全称 (缩写) | 定义与说明 |
| :--- | :--- |
| **数据完整性 (Data Integrity)** | 保证数据在传输、存储和处理过程中保持其准确性、一致性和未被篡改的特性。 |
| **校验和 (Checksum)** | 通过对数据块执行一个算法（如CRC32）计算出的一个固定大小的值。接收方可以重新计算并对比该值，以快速检测数据在传输过程中是否发生了错误。 |
| **序列号 (Sequence ID)** | 一个附加到数据包上的、通常是单调递增的数字。接收方可以利用它来检测数据包的丢失或重新排列数据包的顺序。 |
| **否定应答 (NACK)** | Negative Acknowledgment | 一种在可靠传输协议中使用的反馈信号。当接收方检测到数据丢失时，它会向发送方发送一个NACK消息，明确请求重传丢失的数据包。 |
| **队头阻塞 (Head-of-Line Blocking)** | 在一个有序的传输流中，一个旧数据包的丢失或延迟会阻塞所有后续新数据包的交付和处理，即使那些新数据包已经到达。这是TCP在实时场景下的一个主要缺点。 |

-----

## 6 相关文档

  - **核心依赖**:
      - `04_序列化与网络协议.md`
      - `09_显控终端应用设计.md`
  - **相关参考**:
      - `04_数据网关模块设计.md`
      - `README.md` (for Future Evolution)

-----

## 7 变更历史

| 版本号 | 日期 | 作者 | 变更描述 |
| :--- | :--- | :--- | :--- |
| v1.0.0 | 2025-10-15 | Klein | **初始版本创建**: 确立了以序列号机制为核心的丢包检测方案，设计了基于CRC32c的校验和机制，并为未来的NACK可靠性增强策略进行了概念规划。 |
