# 模块化设计

本目录包含了雷达数据处理系统（Radar Data Processing System）中所有核心模块与基础服务的详细设计文档。每个文档都遵循项目统一的架构原则，如**事件驱动架构**、**依赖注入**、**策略模式**和**清晰的职责分离**，共同构建了一个高性能、高内聚、低耦合的模块化系统。

## 模块/服务总览

下表概述了系统的主要构成部分、它们的核心职责以及对应的详细设计文档。

| 模块/服务 (Module/Service) | 核心职责 (Core Responsibilities) | 设计文档 (Design Document) |
| :--- | :--- | :--- |
| **数据流处理模块 (Data Flow Modules)** | | |
| `DataReceiver` (数据接收模块) | 负责从雷达阵面高效、可靠地接收UDP数据包，并实现零拷贝的数据流转。 | 01_数据接收模块设计.md |
| `SignalProcessor` (信号处理模块) | 利用GPU（CUDA）对原始数据进行高性能的并行信号处理，如FFT、脉冲压缩等。 | 02_信号处理模块设计.md |
| `DataProcessor` (数据处理模块) | 对信号处理结果进行高级业务处理，包括目标检测、关联、跟踪和航迹管理。 | 03_数据处理模块设计.md |
| `DisplayController` (显控接口模块) | 提供人机交互界面（HMI），负责实时数据可视化、系统状态监控和用户操作指令下发。 | 04_显控接口模块设计.md |
| **系统协调与基础设施 (System Coordination & Infrastructure)** | | |
| `TaskScheduler` (任务调度器) | 作为系统的事件驱动协调中枢，管理模块生命周期、协调模块间通信和故障恢复。 | 05_任务调度器设计.md |
| `ConfigManager` (配置管理模块) | 集中管理系统所有配置，支持分层加载、运行时热更新和变更事件通知。 | 06_配置管理模块设计.md |
| `LoggingService` (日志服务) | 提供高性能、异步的结构化日志记录服务，并集成全链路追踪（Trace ID）。 | 07_日志服务设计.md |
| `MonitoringModule` (监控服务) | 主动监控系统资源（CPU/GPU/内存）和业务性能指标，通过事件总线发布告警。 | 08_监控服务设计.md |
| **集成策略 (Integration Strategy)** | | |
| 模块集成策略 | 定义了所有模块必须遵循的统一接口、通信协议、错误处理和生命周期管理规范。 | 99_模块集成策略.md |

---

## 核心模块与服务详解

### 1. 数据流处理模块

#### 1.1 `DataReceiver` (数据接收模块)
作为系统的数据入口，`DataReceiver` 专注于以极致的性能和可靠性接收网络数据。
- **核心架构**: 采用**多级流水线并发模型**，将网络I/O与数据解析任务分离到不同的线程（I/O线程和工作线程池），避免计算任务阻塞网络接收。
- **性能优化**: 实现从网卡到GPU的**端到端零拷贝**数据流，通过页锁定内存池（Pinned Memory Pool）和指针传递，彻底消除内存拷贝开销。
- **可靠性**: 内置基于阻塞队列的**隐式背压机制**，能有效防止下游处理慢导致的数据丢失。同时支持端口动态发现和网络接口就绪等待，增强了部署的灵活性和鲁棒性。

#### 1.2 `SignalProcessor` (信号处理模块)
系统的计算核心，负责将原始数据转换为有意义的信号特征。
- **核心架构**: 完全基于**GPU（NVIDIA CUDA）**进行并行计算。所有算法（FFT, CFAR, 滤波等）均通过**策略模式**实现，可由配置文件动态组合成算法流水线。
- **性能优化**: 采用**三重缓冲**和多CUDA流技术，实现数据传输（H2D/D2H）与核函数计算的完全重叠。
- **资源协调**: 设计了**抢占式CUDA流优先级控制**机制，能响应显控模块的请求，动态降低计算任务优先级，避免UI渲染与科学计算争抢GPU资源导致界面卡顿或驱动崩溃（TDR）。

#### 1.3 `DataProcessor` (数据处理模块)
承接信号处理结果，执行雷达系统最核心的业务逻辑——目标跟踪。
- **核心架构**: 采用**分阶段并行处理**策略，将数据关联、航迹滤波等计算密集型任务并行化。所有算法同样基于**策略模式**，支持在关联（NN/JPDA）、滤波（Kalman/EKF）等阶段灵活切换实现。
- **职责分离**: 清晰地分离了**航迹数据库（TrackManager）**和**航迹生命周期管理（TrackLifecycleManager）**的职责，前者负责高效存取，后者负责状态机逻辑（如`Tentative` -> `Confirmed` -> `Lost`）。
- **事件驱动**: 不执行具体业务决策（如“目标进入禁区”），而是通过事件总线发布`TRACK_CREATED`、`TRACK_LOST`等标准事件，由上层业务模块订阅和决策。

#### 1.4 `DisplayController` (显控接口模块)
系统与用户交互的唯一窗口，提供专业、流畅的可视化与控制功能。
- **核心架构**: 基于 **Qt6 Widgets** 和 **MVP（Model-View-Presenter）** 架构模式，并引入 **ViewModel** 层，彻底分离UI渲染与业务逻辑。
- **高性能渲染**: 渲染管线采用**策略模式**，将不同图层（如网格、目标、航迹）的绘制逻辑封装为独立的、可优化的渲染策略。利用**空间索引（四叉树）**对视口剔除、目标拾取等交互操作进行加速，确保在高目标密度下（>10000个）依然保持流畅。
- **GPU协调**: 作为GPU资源协调的发起者，当UI渲染需求增加时，会通过事件总线请求`SignalProcessor`让出GPU资源，保证界面的响应性。

### 2. 系统协调与基础设施

#### 2.1 `TaskScheduler` (任务调度器)
系统的“大脑”和“神经中枢”，负责协调所有模块的运作。
- **核心架构**: 纯粹的**事件驱动**模型，自身不执行具体业务，而是作为“决策者”响应各模块上报的事件。
- **生命周期管理**: 通过统一的状态机和标准的生命周期事件（如`ModuleRunning`, `ModuleFailed`）管理所有模块的启停、暂停和恢复。
- **智能容错**: 集成**依赖感知恢复**和**熔断机制**。当模块上报致命错误时，它能根据预定义的依赖关系图，精确地重启受影响的模块链，并利用指数退避策略防止“恢复风暴”。

#### 2.2 `ConfigManager` (配置管理模块)
作为系统配置的唯一可信来源，确保配置的一致性、安全性和灵活性。
- **核心架构**: 支持**分层配置**（基础、模块、环境、用户），并采用**深度合并**策略生成最终的有效配置。
- **事件驱动**: 彻底摒弃同步的`get_config()`接口，所有配置的读取和变更均通过**事件总线**进行。模块在启动时获取一次性快照，后续通过订阅`CONFIG_CHANGED`事件来接收热更新。
- **并发安全**: 引入**状态机（IDLE/VALIDATING/APPLYING）**来管理配置变更流程，有效防止了并发请求导致的验证冲突和状态不一致问题。

#### 2.3 `LoggingService` (日志服务)
为整个系统提供统一、高性能的日志记录能力。
- **核心架构**: 基于`spdlog`实现**异步日志记录**，通过无锁队列将I/O操作转移到后台线程，确保日志调用对业务线程的性能影响降至最低（纳秒级）。
- **零开销宏**: 提供`RADAR_DEBUG`等宏，在日志级别禁用时，相关代码（包括参数构造）会被编译器完全优化掉，实现真正的零开销。
- **全链路追踪**: 与`TraceContext`深度集成，所有日志自动附加当前线程的`Trace ID`，极大地方便了跨模块、跨线程的复杂问题排查。

#### 2.4 `MonitoringModule` (监控服务)
系统的“眼睛”，主动、持续地监控系统健康状况。
- **核心架构**: 作为一个独立的、主动的`IModule`运行，内置`ExecutionEngine`定时收集系统资源和业务性能指标。
- **推送式聚合**: 针对多线程业务指标的收集难题，采用创新的**“线程主动推送”**模式。业务线程将本地指标批量推送到一个高性能的**MPSC（多生产者单消费者）无锁队列**，由监控模块作为唯一消费者进行安全、高效的聚合。
- **事件驱动告警**: 基于可配置的阈值和规则评估指标，当满足告警条件时，通过事件总线发布`AlertTriggeredEvent`事件，与告警的消费者（如UI、动作处理器）完全解耦。

---
*此文档旨在为开发者提供一个清晰、全面的模块化设计蓝图，指导后续的开发、集成与测试工作。*
